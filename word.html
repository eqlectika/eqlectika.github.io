<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="manifest" href="manifest.json">
    <style>
        :root { --t: 0.4s; --btn: 56px; }
        * { -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; -webkit-tap-highlight-color: transparent; box-sizing: border-box; border-radius: 0 !important; }
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; background: #000; font-family: "Times New Roman", serif; font-size: 16px; }
        
        #gateway { display: grid; grid-template-columns: 1fr 1fr; height: 100%; width: 100%; position: absolute; z-index: 1000; transition: transform var(--t) ease; background: #000; }
        .input-pane { border: none; padding: 20px; font-size: 1.1rem; font-family: serif; resize: none; height: 100%; width: 100%; outline: none; }
        .light { background: #fff; color: #000; }
        .dark { background: #000; color: #fff; }

        .master-btn { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: var(--btn); height: var(--btn); border-radius: 50% !important; border: 1px solid #666; background: #111; color: #fff; cursor: pointer; z-index: 2000; display: flex; align-items: center; justify-content: center; font-size: 9px; letter-spacing: 1px; }

        .app-container { display: grid; height: 100vh; grid-template-columns: 1fr 0fr 1fr; transition: grid-template-columns var(--t) ease; }
        .pane { overflow-y: auto; padding: 15px; line-height: 1.4; border: none; }
        .central-col { display: grid; grid-template-rows: 1fr 1fr; overflow: hidden; background: transparent; }
        
/* СТАЛО: */
.central-col.final { 
    grid-template-rows: 1fr auto 1fr; 
}
.final-row { 
    display: none; 
    grid-template-columns: 1fr 1fr; 
    height: auto; 
}
        .central-col.final .final-row { display: grid; }

        .word { cursor: pointer; padding: 0 1px; }
        .light .word.active { background: #000; color: #fff; }
        .dark .word.active { background: #fff; color: #000; }
        
        .footer-logo { position: absolute; bottom: 15px; left: 50%; transform: translateX(-50%); z-index: 3000; }
        .footer-logo img { height: 35px; width: auto; display: block; opacity: 1; filter: grayscale(100%); }
        .hidden { display: none; }
        .example { display: block; margin-top: 8px; font-style: italic; opacity: 0.9; }
    </style>
</head>
<body>

<div id="gateway">
    <textarea id="inL" class="input-pane light">Привет, мир!</textarea>
    <div style="position: absolute; left: 50%; height: 100%; width: 0; background: transparent;"><div class="master-btn" onclick="launchApp()">SYNC</div></div>
    <textarea id="inD" class="input-pane dark">Hello, world!</textarea>
</div>

<div class="master-btn hidden" id="uiBtn" onclick="handleUIBtn()">GATE</div>

<div class="app-container" id="main">
    <div class="pane light" id="outL"></div>
    <div class="central-col" id="center">
        <div class="pane light" id="s2-top"></div>
        <div class="final-row" id="s3-row"><div class="pane light" id="s3-L"></div><div class="pane dark" id="s3-D"></div></div>
        <div class="pane dark" id="s2-bot"></div>
    </div>
    <div class="pane dark" id="outD"></div>
</div>

<a href="/index.html" class="footer-logo"><img src="logo.png" alt="logo"></a>

<script>
let state = 0;

const db = {
    "привет": { 
        l1: ["Приветствие (межд.).", "Пример: Привет, друг!", "Greeting (intj.).", "Example: Hello, friend!"], 
        l2: ["От др.-русск. привѣтъ (совет).", "Пример: Добрый привет.", "From Old Slavic 'privet'.", "Example: Kind greeting."],
        pair: "hello" 
    },
    "hello": { 
        l1: ["Greeting (intj.).", "Example: Hello, friend!", "Приветствие (межд.).", "Пример: Привет, друг!"], 
        l2: ["From Old German 'hallo'.", "Example: Say hello.", "От др.-герм. hallo.", "Пример: Скажи привет."],
        pair: "привет" 
    },
    "мир": { 
        l1: ["Вселенная (сущ.).", "Пример: Наш мир велик.", "Universe (noun).", "Example: Our world is big."], 
        l2: ["От праслав. mirъ (покой).", "Пример: Жить в мире.", "From Proto-Slavic mir (peace).", "Example: Live in peace."],
        pair: "world" 
    },
    "world": { 
        l1: ["Universe (noun).", "Example: Our world is big.", "Вселенная (сущ.).", "Пример: Наш мир велик."], 
        l2: ["From Old English 'weorold'.", "Example: Whole world.", "От др.-англ. weorold.", "Пример: Весь мир."],
        pair: "мир" 
    }
};

function tokenize(t) {
    if (!t) return "";
    if (Array.isArray(t)) {
        return `<div>${tokenize(t[0])}</div><div class="example">${tokenize(t[1])}</div>`;
    }
    return t.split(/(\s+|[,!?.])/).map(p => {
        if (/[\s+,!?. ]/.test(p) || p === "") return p;
        return `<span class="word" data-raw="${p.toLowerCase().replace(/[.,!?]/g, '')}">${p}</span>`;
    }).join('');
}

function launchApp() {
    document.getElementById('outL').innerHTML = tokenize(document.getElementById('inL').value);
    document.getElementById('outD').innerHTML = tokenize(document.getElementById('inD').value);
    document.getElementById('gateway').style.transform = 'translateY(-100%)';
    document.getElementById('uiBtn').classList.remove('hidden');
    state = 1;
}

document.addEventListener('click', (e) => {
    const w = e.target.closest('.word');
    if (!w || state === 0) return;

    const raw = w.dataset.raw;
    const pane = w.closest('.pane');
    if (!pane) return;
// Динамическая смена языка документа
if (pane.classList.contains('light')) {
    document.documentElement.lang = 'ru';
} else if (pane.classList.contains('dark')) {
    document.documentElement.lang = 'en';
}

    // Сброс и инверсия
    document.querySelectorAll('.word').forEach(el => el.classList.remove('active'));
    
    // Сквозной поиск по всему документу (для гарантии отзыва)
    document.querySelectorAll(`.word[data-raw="${raw}"]`).forEach(el => el.classList.add('active'));
    
    // Поиск партнера только для Уровня 0
    if (pane.id === 'outL' || pane.id === 'outD') {
        const partnerRaw = db[raw]?.pair;
        if (partnerRaw) document.querySelectorAll(`.word[data-raw="${partnerRaw}"]`).forEach(el => el.classList.add('active'));

        document.getElementById('main').style.gridTemplateColumns = '1fr 1.5fr 1fr';
        const entry = db[raw] || { l1: [`Толкование: ${raw}`, `Пример: ...`, `Definition: ${raw}`, `Example: ...`] };
        document.getElementById('s2-top').innerHTML = tokenize([entry.l1[0], entry.l1[1]]);
        document.getElementById('s2-bot').innerHTML = tokenize([entry.l1[2], entry.l1[3]]);
        
        document.getElementById('center').classList.remove('final');
        document.getElementById('uiBtn').innerText = "CLOSE";
        state = 2;
    } 
    else if (pane.id === 's2-top' || pane.id === 's2-bot') {
        const entry = db[raw] || { l2: [`Этимология`, `Пример: ...`, `Etymology`, `Example: ...`] };
        document.getElementById('center').classList.add('final');
        document.getElementById('s3-L').innerHTML = tokenize([entry.l2 ? entry.l2[0] : "Этимология"]);
        document.getElementById('s3-D').innerHTML = tokenize([entry.l2 ? entry.l2[2] : "Etymology"]);
        document.getElementById('uiBtn').innerText = "RESET";
        state = 3;
    }
});

function handleUIBtn() {
    if (state >= 2) {
        document.getElementById('main').style.gridTemplateColumns = '1fr 0fr 1fr';
        document.getElementById('center').classList.remove('final');
        document.querySelectorAll('.word').forEach(el => el.classList.remove('active'));
        document.getElementById('uiBtn').innerText = "GATE";
        state = 1;
    } else if (state === 1) {
        document.getElementById('gateway').style.transform = 'translateY(0)';
        document.getElementById('uiBtn').classList.add('hidden');
        state = 0;
    }
}
</script>
</body>
</html>
