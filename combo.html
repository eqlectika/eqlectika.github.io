<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>S.P.A.R.K. Matrix Final</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg: #000; --text: #fff; --accent: #00ff00; --tension: #ff1493; --dim: #111; }
        * { box-sizing: border-box; font-family: 'Courier New', monospace; -webkit-tap-highlight-color: transparent; }
        body, html { margin: 0; padding: 0; height: 100dvh; background: var(--bg); color: var(--text); overflow: hidden; display: flex; flex-direction: column; }

        /* GATEWAY (35% высоты) */

        .pane-wrap { position: relative; height: 100%; width: 100%; overflow: hidden; }
        .pane { border: none; padding: 10px; font-size: 0.85rem; background: var(--bg); color: var(--text); outline: none; resize: none; width: 100%; height: 100%; }
        .pane-l { color: #444; border-right: 1px solid var(--dim); }

        #save-btn { 
            position: absolute; bottom: 5px; right: 5px; background: var(--accent); color: #000; 
            padding: 4px 10px; font-size: 0.6rem; font-weight: bold; cursor: pointer; display: none; z-index: 150;
        }

#gateway { 
    display: grid; 
    grid-template-columns: 50% 50%; /* Сетка по Фибоначчи */
    height: 35%; 
    width: 100%; 
    position: relative; 
    border-bottom: 1px solid var(--dim); 
    flex-shrink: 0; 
}

#gate-btn {
    position: absolute; 
    left: 50%; /* Линия четко на границе сечения */
    top: 0; 
    bottom: 0; 
    width: 22px; 
    transform: translateX(-50%); 
    z-index: 200; 
    cursor: pointer;
    background: var(--accent); 
    display: flex; 
    align-items: center; 
    justify-content: center;
}

#digText {
    padding-left: 25px; /* Комфортный зазор для Digest */
}

        #gate-btn span { writing-mode: vertical-rl; text-orientation: upright; color: #000; font-weight: 900; font-size: 0.65rem; letter-spacing: 3px; }
        #gate-btn.active { background: var(--tension); }

        /* FLASH ZONE (Занимает остаток места) */
        #flash-zone { 
            flex-grow: 1; display: none; flex-direction: column; justify-content: center; align-items: center;
            background: #050505; position: relative; border-bottom: 1px solid var(--dim);
        }
        #flash-zone.visible { display: flex; }
        #word-stream { font-size: 2.8rem; font-weight: bold; text-align: center; cursor: pointer; width: 95%; color: var(--text); }

        /* PINK CONTROLS */
#control-hub {
    height: 40px; 
    width: 100%; 
    display: none; /* Скрыто */
    justify-content: space-around; 
    align-items: center;
    background: #000; 
    flex-shrink: 0;
}

        .u-btn { color: var(--tension); font-size: 0.7rem; cursor: pointer; font-weight: bold; }

        /* BASEMENT (Фиксированная высота, прокрутка внутри) */
        #basement { height: 140px; width: 100%; background: #000; display: flex; flex-direction: column; flex-shrink: 0; border-top: 1px solid var(--dim); overflow-y: auto; }
#index-row {
    width: 100%; 
    min-height: 25px; 
    display: flex; 
    align-items: center; 
    justify-content: center; /* Центрирует текст по горизонтали */
    color: var(--accent); 
    font-size: 0.8rem; 
    letter-spacing: 12px; 
padding-left: 12px;
    font-weight: bold; 
    background: #000;
}

        #monitor { min-height: 60px; width: 100%; position: relative; }


#db-tools { 
    min-height: 45px; 
    display: flex; 
    justify-content: center; /* Центрирует всё содержимое */
    align-items: center; 
    gap: 20px; 
    padding: 5px; 
}

.db-btn { 
    font-size: 0.7rem; 
    color: var(--accent); /* Изменили с #666 на ярко-зеленый */
    cursor: pointer; 
    border: 1px solid var(--accent); /* Добавили рамку в цвет текста */
    padding: 5px 10px; 
    text-transform: uppercase; 
    font-weight: bold;
    transition: 0.3s; /* Для плавного эффекта */
}

/* Центрирование самого логотипа как отдельного блока */
.centered-logo {
    display: flex;
    justify-content: center;
    align-items: center;
    width: 100%;
    padding: 10px 0;
    text-decoration: none;
}



        video { position: fixed; width: 1px; height: 1px; opacity: 0; }
 
/* Обновленный подвал теперь растет по контенту или скроллится */
#basement { 
    height: auto; 
    max-height: 220px; 
    width: 100%; 
    background: #000; 
    display: flex; 
    flex-direction: column; 
    flex-shrink: 0; 
    border-top: 1px solid var(--dim); 
    overflow-y: auto; 
}


/* Стили из loop.html, адаптированные под Matrix */
footer { padding: 10px 0; flex-shrink: 0; }

.donate-btn { 
    color: #888; 
border: 1px solid #444; 
padding: 5px 15px; 
    background: transparent; 
cursor: pointer; 
font-size: 0.6rem; 
text-transform: uppercase; 
width: fit-content;
    margin: 0 auto; 
}


.donate-box { 
    display: flex; 
    flex-direction: column; 
    align-items: center; /* Центрирует кнопку и крипто-адрес */
    gap: 8px; 
    padding: 0 15px; 
    text-align: center; /* Центрирует текст внутри блоков */
}


.crypto-info { display: none; flex-direction: column; gap: 5px; margin-top: 10px; }
.crypto-address-display { 
    font-size: 10px; color: var(--accent); background: #0a0a0a; 
    padding: 8px; border: 1px dashed #333; cursor: copy; word-break: break-all; 
}

   </style>
</head>
<body>

    <video id="video" autoplay playsinline muted></video>

    <div id="gateway">
        <div class="pane-wrap"><textarea id="srcText" class="pane pane-l" placeholder="SOURCE"></textarea></div>
        <div class="pane-wrap">
            <textarea id="digText" class="pane" placeholder="DIGEST" oninput="checkDigest()"></textarea>
            <div id="save-btn" onclick="exportDB()">SAVE</div>
        </div>
        <div id="gate-btn" onclick="toggleSystem()"><span>GATE</span></div>
    </div>

    <div id="flash-zone">
        <div id="word-stream" onclick="captureWord()">READY</div>
    </div>

    <div id="control-hub">
        <div class="u-btn" onclick="move(-10)">PREV</div>
        <div class="u-btn" onclick="adjSpd(-50)">SLOWER</div>
        <div class="u-btn" id="run-btn" onclick="toggleRun()">RUN</div>
        <div class="u-btn" onclick="adjSpd(50)">FASTER</div>
        <div class="u-btn" onclick="move(10)">NEXT</div>
    </div>

<div id="basement">
    <div id="index-row">RQ:85</div>
    <div id="monitor"><canvas id="sparkChart"></canvas></div>
    
    <div id="db-tools">
        <div class="db-btn" onclick="exportDB()">EXPORT DB</div>
        <div class="db-btn" onclick="document.getElementById('importInput').click()">IMPORT DB</div>
        <input type="file" id="importInput" style="display:none" onchange="importDB(event)">
    </div>

    <a href="index.html" class="centered-logo">
        <img src="logo.png" alt="Feedback" style="height: 38px; opacity: 0.9; width: auto;">
    </a>

    <footer>
        <div class="donate-box">
            <button class="donate-btn" onclick="toggleDonate()">Support</button>
            <div id="cryptoInfo" class="crypto-info">
                <span style="font-size: 10px; color: #fff;">USDT BSC (BEP20)</span>
                <div id="cryptoAddr" class="crypto-address-display" onclick="copyToClipboard()">0x769192cea8fbb7207f086d95fd653ebc3adb0c72</div>
                <span id="copyHint" style="font-size: 9px; color: #aaa;">Click address to copy</span>
            </div>
        </div>
    </footer>
</div>



    <script>
        let isRunning = false, isPaused = true, words = [], currentIdx = 0, speed = 300, rq = 85, timer = null;

        const chart = new Chart(document.getElementById('sparkChart').getContext('2d'), {
            type: 'line',
            data: { labels: Array(40).fill(''), datasets: [{ borderColor: '#00ff00', borderWidth: 1, data: Array(40).fill(85), pointRadius: 0, fill: false, tension: 0.4 }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { display: false, max: 100, min: 0 }, x: { display: false } }, plugins: { legend: { display: false } } }
        });

function toggleSystem() {
    const flash = document.getElementById('flash-zone');
    const btn = document.getElementById('gate-btn');
    const hub = document.getElementById('control-hub');

    if (!isRunning) {
        // Инициализация камеры
        navigator.mediaDevices.getUserMedia({video: true})
            .then(s => { document.getElementById('video').srcObject = s; })
            .catch(() => {});

        // Чтение слов из SOURCE
        words = document.getElementById('srcText').value.split(/\s+/).filter(w => w.length > 0);
        
        if (words.length === 0) {
            alert("Введите текст в SOURCE");
            return;
        }

        flash.style.display = 'flex'; 
        hub.style.display = 'flex'; 
        btn.classList.add('active');
        isRunning = true; 
        currentIdx = 0; 
        isPaused = true; 
        update();
    } else {
        isRunning = false; 
        isPaused = true; 
        clearTimeout(timer);
        
        flash.style.display = 'none'; 
        hub.style.display = 'none'; 
        btn.classList.remove('active');
        document.getElementById('run-btn').innerText = 'RUN';
        document.getElementById('run-btn').style.color = '';
    }
}



        function update() {
            if (!words[currentIdx]) return;
            document.getElementById('word-stream').innerText = words[currentIdx];
            document.getElementById('index-row').innerText = `RQ: ${Math.round(rq)}`;
        }

        function toggleRun() {
            if (!isRunning) return;
            isPaused = !isPaused;
            document.getElementById('run-btn').innerText = isPaused ? 'RUN' : 'STOP';
            document.getElementById('run-btn').style.color = isPaused ? '' : 'var(--tension)';
            if (!isPaused) loop();
        }

        function loop() {
            if (isRunning && !isPaused && currentIdx < words.length - 1) {
                currentIdx++; update();
                timer = setTimeout(loop, 60000 / (speed * (rq/100)));
            }
        }

        function adjSpd(d) { speed = Math.max(50, speed + d); update(); }
        function move(d) { currentIdx = Math.max(0, Math.min(words.length-1, currentIdx + d)); update(); }

        function captureWord() {
            if (!words[currentIdx]) return;
            const w = words[currentIdx].replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g,"");
            document.getElementById('digText').value += w + ': ';
            checkDigest();
            document.getElementById('word-stream').style.color = 'var(--tension)';
            setTimeout(() => document.getElementById('word-stream').style.color = '', 100);
        }

        function checkDigest() {
            document.getElementById('save-btn').style.display = document.getElementById('digText').value.trim().length > 0 ? 'block' : 'none';
        }

        function exportDB() {
            const data = JSON.stringify({src: document.getElementById('srcText').value, dig: document.getElementById('digText').value});
            const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([data], {type:'application/json'})); a.download = 'matrix.json'; a.click();
        }

        function importDB(e) {
            const reader = new FileReader();
            reader.onload = (ev) => {
                const data = JSON.parse(ev.target.result);
                document.getElementById('srcText').value = data.src || '';
                document.getElementById('digText').value = data.dig || '';
                checkDigest();
            };
            reader.readAsText(e.target.files[0]);
        }

        setInterval(() => {
    // Вычисляем новое значение
    rq = Math.max(10, Math.min(100, rq + (Math.random() - 0.5) * 6));
    
    // Обновляем график
    chart.data.datasets[0].data.push(rq); 
    chart.data.datasets[0].data.shift();
    chart.update('none');
    
    // ДОБАВЬТЕ ЭТУ СТРОКУ: она обновляет цифру в блоке index-row
    document.getElementById('index-row').innerText = `RQ: ${Math.round(rq)}`;
    
    // Меняем цвет в зависимости от состояния
    const c = rq > 50 ? '#00ff00' : '#ff1493';
    document.getElementById('index-row').style.color = c;
    chart.data.datasets[0].borderColor = c;
}, 1000);

        
        function toggleDonate() { 
    const info = document.getElementById("cryptoInfo"); 
    info.style.display = info.style.display === "flex" ? "none" : "flex"; 
}

function copyToClipboard() {
    const addr = document.getElementById("cryptoAddr");
    const text = addr.innerText;
    navigator.clipboard.writeText(text).then(() => {
        const originalText = text;
        addr.innerText = "COPIED!";
        addr.style.color = "var(--tension)";
        setTimeout(() => {
            addr.innerText = originalText;
            addr.style.color = "var(--accent)";
        }, 1500);
    });
}

    </script>
</body>
</html>
