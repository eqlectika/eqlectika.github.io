<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="manifest" href="manifestspark.json">
  <title>Vital Spark</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --main-font: monospace; --bg-color: #000; --time-color: #8493d6; --breath-color: #ffffff;
      --pulse-color: #ff1493; --emotion-color: #ff5252; --energy-color: #ff9800; --focus-color: #ffeb3b;
      --creativity-color: #00ff00; --vision-color: #0000ff; --hearing-color: #9c27b0; --smell-color: #00bcd4;
      --dopamine-color: #ff00ff; --boomerang-color: #ff4500; --load-color: #adff2f;
      --tension-color: #cccccc; --light-gray: #aaaaaa;
    }
    
    body { background: var(--bg-color); color: #fff; font-family: var(--main-font); padding: 20px; margin: 0; display: flex; flex-direction: column; min-height: 100vh; user-select: none; }
    .header-container { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
    .logo-image { max-width: 48px; opacity: 0.9; }
    .protocol-details { cursor: pointer; margin-bottom: 25px; font-size: 13px; color: #666; }
    .protocol-content { border-left: 1px solid #333; padding: 10px 0 10px 15px; margin-top: 10px; line-height: 1.6; color: #aaa; }
    .select-container { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 30px; }
    .select-group { flex: 1 1 180px; display: flex; flex-direction: column; }
    .select-group label { margin-bottom: 8px; font-weight: bold; font-size: 14px; }
    select { appearance: none; background: #000; color: #fff; border: 1px solid var(--light-gray); padding: 12px; font-family: var(--main-font); font-size: 14px; cursor: pointer; }
    .chart-container { position: relative; height: 40vh; width: 100%; margin-top: 20px; }
    #risk-container { margin-top: 20px; border: 1px solid #333; padding: 15px; }
    .buttons { margin-top: 20px; display: flex; gap: 10px; }
    button.ui-btn { background: #111; color: var(--light-gray); border: 1px solid #444; padding: 8px 12px; font-family: var(--main-font); cursor: pointer; font-size: 11px; }
    
    #savedDataView { 
      background: #0a0a0a; color: var(--creativity-color); padding: 15px; font-size: 11px; 
      border: 1px solid #222; margin-top: 10px; max-height: 300px; overflow-y: auto; 
      white-space: pre-wrap; font-family: var(--main-font); display: none;
    }

    footer { margin-top: auto; padding: 40px 0 20px; }
    .donate-box { display: flex; flex-direction: column; gap: 10px; }
    .donate-btn { color: var(--light-gray); border: 1px solid var(--light-gray); padding: 5px 15px; background: transparent; cursor: pointer; font-family: var(--main-font); width: fit-content; transition: 0.3s; }
    .donate-btn:hover { background: var(--light-gray); color: #000; }
    .crypto-info { display: none; flex-direction: column; gap: 5px; margin-top: 10px; }
    .crypto-address-display { font-size: 11px; color: #fff; background: #111; padding: 8px 12px; border: 1px dashed #555; cursor: copy; word-break: break-all; max-width: 280px; }
   
    .magic-word {
      transition: all 0.3s ease;
      border-bottom: 1px dotted #444;
      cursor: pointer;
    }
    .magic-word.active {
      color: var(--bg-color);
      background: var(--creativity-color);
    }

  
  </style>
</head>
<body>

<div class="header-container">
  <a href="index.html" style="width: fit-content; line-height: 0;">
    <img src="logo.png" alt="Logo" class="logo-image">
  </a>
  <div><h2 style="margin: 0;">Vital Spark</h2><p style="margin: 4px 0 0;">Personal state protocol</p></div>
</div>

<details class="protocol-details">
  <summary>Emotionomics: Help mindset [?]</summary>
  <div class="protocol-content">
    <p>The essence is not to avoid or adapt, but to master the psyche: resolve the triggers to the core, again and again — perhaps, many times over.</p>
    <p><strong>The Boomerang Logic:</strong></p>
    <ul style="list-style: none; padding-left: 0; font-size: 11px; color: #aaa;">
      <li style="margin-bottom: 8px;"><strong>Impact</strong> - Blind impulse. A strike aimed at the void that inevitably hits back.</li>
      <li style="margin-bottom: 8px;"><strong>Magnetism</strong> - False patterns. When systemic noise begins to masquerade as logic.</li>
      <li style="margin-bottom: 8px;"><strong>Gravity</strong> - Grounding. Recognizing the heavy weight of hidden risks and total supply.</li>
      <li style="margin-bottom: 8px;"><strong>Cooling</strong> - Intellectual ice. The emotional charge is gone; only the anatomy of facts remains.</li>
      <li style="margin-bottom: 8px;"><strong>Ejection</strong> - Absolute exit. You are no longer part of the equation. Action is effortless or unnecessary.</li>
    </ul>
    <p style="margin-top: 15px; border-top: 1px solid #222; padding-top: 10px; font-style: italic;">In the tempest — follow only the protocol.</p>
  </div>
</details>

<div id="risk-container">
  <div style="display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 5px;"><span>State Index (Rq)</span><span id="risk-value">0.00</span></div>
  <div style="width: 100%; background: #111; height: 8px; border-radius: 4px; overflow: hidden;"><div id="risk-bar" style="width: 0%; height: 100%; background: #ff5252; transition: 0.5s;"></div></div>
  <div style="display: flex; justify-content: space-between; font-size: 10px; margin-top: 5px; color: #333;"><span id="unreal-indicator">Unreal ←</span><span id="real-indicator">→ Real</span></div>
  <p id="risk-advice" style="font-size: 10px; color: #666; margin-top: 8px; font-style: italic;">Calibrate metrics...</p>
</div>

<div class="chart-container"><canvas id="chart"></canvas></div>

<div class="select-container">
  <div class="select-group"><label for="time" style="color: var(--time-color);">Timeframe</label><select id="time" onchange="log('time')"><option selected disabled>—</option><option value="1">Minute</option><option value="2">Hour</option><option value="3">Day</option><option value="4">Week</option><option value="5">Month</option></select></div>
  <div class="select-group"><label for="breath" style="color: var(--breath-color);">Breathing</label><select id="breath" onchange="log('breath')"><option selected disabled>—</option><option value="1">Mouth in/out</option><option value="2">Mouth in, nose out</option><option value="3">Sensing...</option><option value="4">Nose in/out</option><option value="5">Nose in, mouth out</option></select></div>
  <div class="select-group"><label for="pulse" style="color: var(--pulse-color);">Pulse</label><select id="pulse" onchange="log('pulse')"><option selected disabled>—</option><option value="1">&lt; 60</option><option value="2">60-80</option><option value="3">80-100</option><option value="4">100-120</option><option value="5">&gt; 120</option></select></div>
  <div class="select-group"><label for="emotion" style="color: var(--emotion-color);">Emotions</label><select id="emotion" onchange="log('emotion')"><option selected disabled>—</option><option value="1">Anxiety</option><option value="2">Harmony</option><option value="3">Calmness</option><option value="4">Joy</option><option value="5">Serenity</option></select></div>
  <div class="select-group"><label for="dopamine" style="color: var(--dopamine-color);">Anticipation</label><select id="dopamine" onchange="log('dopamine')"><option selected disabled>—</option><option value="1">Urgency</option><option value="2">Excited</option><option value="3">Neutral</option><option value="4">Patient</option><option value="5">Stoic</option></select></div>
  <div class="select-group"><label for="load" style="color: var(--load-color);">Cognitive Load</label><select id="load" onchange="log('load')"><option selected disabled>—</option><option value="1">Overloaded</option><option value="2">Tired</option><option value="3">Stable</option><option value="4">Fresh</option><option value="5">Hyper-aware</option></select></div>
  <div class="select-group"><label for="tension" style="color: var(--tension-color);">Body Tension</label><select id="tension" onchange="log('tension')"><option selected disabled>—</option><option value="1">Rigid</option><option value="2">Tense</option><option value="3">Noticeable</option><option value="4">Relaxed</option><option value="5">Fluid</option></select></div>
  <div class="select-group"><label for="energy" style="color: var(--energy-color);">Energy</label><select id="energy" onchange="log('energy')"><option selected disabled>—</option><option value="1">Exhausted</option><option value="2">Low</option><option value="3">Medium</option><option value="4">High</option><option value="5">Peak</option></select></div>
  <div class="select-group"><label for="focus" style="color: var(--focus-color);">Focus</label><select id="focus" onchange="log('focus')"><option selected disabled>—</option><option value="1">Distracted</option><option value="2">Intermittent</option><option value="3">Stable</option><option value="4">Strong</option><option value="5">Full</option></select></div>
  <div class="select-group"><label for="creativity" style="color: var(--creativity-color);">Creativity</label><select id="creativity" onchange="log('creativity')"><option selected disabled>—</option><option value="1">Block</option><option value="2">Rare</option><option value="3">Productive</option><option value="4">Active</option><option value="5">Flow</option></select></div>
  <div class="select-group"><label for="vision" style="color: var(--vision-color);">Vision</label><select id="vision" onchange="log('vision')"><option selected disabled>—</option><option value="1">Blurred</option><option value="2">Dim</option><option value="3">Normal</option><option value="4">Clear</option><option value="5">Vivid</option></select></div>
  <div class="select-group"><label for="hearing" style="color: var(--hearing-color);">Hearing</label><select id="hearing" onchange="log('hearing')"><option selected disabled>—</option><option value="1">Muffled</option><option value="2">Weak</option><option value="3">Normal</option><option value="4">Detailed</option><option value="5">Acute</option></select></div>
  <div class="select-group"><label for="smell" style="color: var(--smell-color);">Smell</label><select id="smell" onchange="log('smell')"><option selected disabled>—</option><option value="1">None</option><option value="2">Faint</option><option value="3">Normal</option><option value="4">Sharp</option><option value="5">Sensitive</option></select></div>
  <div class="select-group"><label for="boomerang" style="color: var(--boomerang-color);">Boomerang Logic</label><select id="boomerang" onchange="log('boomerang')"><option selected disabled>—</option><option value="1">Impact</option><option value="2">Magnetism</option><option value="3">Gravity</option><option value="4">Cooling</option><option value="5">Ejection</option></select></div>
</div>

<div class="buttons">
  <button class="ui-btn" onclick="toggleData()">Archive</button>
  <button class="ui-btn" onclick="if(confirm('Reset?')) { localStorage.clear(); location.reload(); }">Reset</button>
</div>
<pre id="savedDataView"></pre>



<footer>
  <div class="donate-box">
    <button class="donate-btn" onclick="toggleDonate()">Support</button>
    <div id="cryptoInfo" class="crypto-info">
      <span style="font-size: 10px; color: var(--light-gray); margin-bottom: 4px;">Network: Tron (TRC20)</span>
      <div id="cryptoAddr" class="crypto-address-display" onclick="copyToClipboard()">TBL5FqL1zSGdP9k6nGkakxmPM26ttcJ496</div>
      <span id="copyHint" style="font-size: 9px; color: #666; margin-top: 4px;">Click address to copy</span>
    </div>
  </div>
</footer>

<script>
  const rows = ['time', 'breath', 'pulse', 'emotion', 'dopamine', 'load', 'tension', 'energy', 'focus', 'creativity', 'vision', 'hearing', 'smell', 'boomerang'];
  const colors = {
    time: '#8493d6', breath: '#ffffff', pulse: '#ff1493', emotion: '#ff5252', dopamine: '#ff00ff',
    load: '#adff2f', tension: '#cccccc', energy: '#ff9800', focus: '#ffeb3b', creativity: '#00ff00',
    vision: '#0000ff', hearing: '#9c27b0', smell: '#00bcd4', boomerang: '#ff4500'
  };
  const categoryNames = {
    time: 'Time', breath: 'Breath', pulse: 'Pulse', emotion: 'Emotions', dopamine: 'Anticipation',
    load: 'Load', tension: 'Tension', energy: 'Energy', focus: 'Focus', creativity: 'Creativity',
    vision: 'Vision', hearing: 'Hearing', smell: 'Smell', boomerang: 'Boomerang'
  };

  const STORAGE_KEY = "vital_spark_bio_v1";
  const ctx = document.getElementById('chart').getContext('2d');
  const chart = new Chart(ctx, {
    type: 'line',
    data: { labels: [], datasets: rows.map(key => ({ label: categoryNames[key], data: [], borderColor: colors[key], borderWidth: 2, pointRadius: 2, fill: false, tension: 0.3 })) },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { min: 0.8, max: 5.2, display: false }, x: { display: false } } }
  });

  function log(key) {
    const val = +document.getElementById(key).value;
    let col = chart.data.labels.length;
    const isColumnFull = col > 0 && chart.data.datasets.every(ds => ds.data[col - 1] != null);
    if (isColumnFull || col === 0) chart.data.labels.push(++col);
    chart.data.datasets[rows.indexOf(key)].data[col - 1] = val;
    chart.update();
    saveToStorage(); updateRiskIndicator();
  }

  function calculateRiskQuine() {
    const data = chart.data.datasets; 
    const lastIdx = chart.data.labels.length - 1;
    if (lastIdx < 0) return "0.00";
    const vals = data.map(ds => ds.data[lastIdx]).filter(v => v != null);
    if (vals.length === 0) return "0.00";
    const avg = vals.reduce((a, b) => a + b, 0) / vals.length;
    return Math.min(avg / 5, 1).toFixed(2);
  }

  function updateRiskIndicator() {
    const score = calculateRiskQuine();
    const bar = document.getElementById('risk-bar');
    const advice = document.getElementById('risk-advice');
    
    document.getElementById('risk-value').innerText = score;
    bar.style.width = (score * 100) + '%';
    
    document.getElementById('unreal-indicator').style.color = (score > 0 && score < 0.45) ? '#ff1493' : '#333';
    document.getElementById('real-indicator').style.color = (score >= 0.75) ? '#00ff00' : '#333';

    if (score < 0.45) { 
      bar.style.background = '#ff1493'; 
      advice.innerText = "Systemic noise - High. Maintain total distance or initiate a fresh calibration."; 
    }
    else if (score < 0.75) { 
      bar.style.background = '#ff9800'; 
      advice.innerText = "Surface calm - De-escalate your involvement and lower the stakes."; 
    }
    else { 
      bar.style.background = '#00ff00'; 
      advice.innerText = "Clarity - Absolute. Your focus is sharp; proceed with effortless intent."; 
    }
  }

  function toggleDonate() { const info = document.getElementById("cryptoInfo"); info.style.display = (info.style.display === "flex") ? "none" : "flex"; }

  function copyToClipboard() {
    const addr = document.getElementById("cryptoAddr");
    const hint = document.getElementById("copyHint");
    const text = addr.innerText;
    navigator.clipboard.writeText(text).then(() => {
      addr.innerText = "Copied!";
      addr.style.color = "var(--creativity-color)";
      if (hint) hint.innerText = "Address saved to clipboard";
      setTimeout(() => {
        addr.innerText = text;
        addr.style.color = "#fff";
        if (hint) hint.innerText = "Click address to copy";
      }, 1500);
    });
  }

  function saveToStorage() {
    const score = calculateRiskQuine();
    let verdict = "";
    if (score < 0.45) verdict = "SYSTEMIC NOISE - High. Distance mandatory.";
    else if (score < 0.75) verdict = "SURFACE CALM - De-escalate involvement.";
    else verdict = "CLARITY - Absolute. Effortless intent.";

    const logEntry = {
      timestamp: new Date().toLocaleString('en-GB'),
      score: score,
      verdict: verdict,
      labels: chart.data.labels,
      data: chart.data.datasets.map(ds => ds.data)
    };

    let history = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
    if (!Array.isArray(history)) history = [];
    history.push(logEntry);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
  }

  function loadFromStorage() { 
    const history = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
    if (history.length === 0) return;
    const last = history[history.length - 1];
    try { 
      chart.data.labels = last.labels || []; 
      last.data.forEach((d, i) => { if(chart.data.datasets[i]) chart.data.datasets[i].data = d; }); 
      chart.update(); 
    } catch(e) {} 
  }

  function toggleData() {
    const pre = document.getElementById("savedDataView");
    if (pre.style.display === "none" || pre.style.display === "") {
      const history = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
      pre.textContent = history.slice().reverse().map(entry => 
        `[${entry.timestamp}] Rq: ${entry.score}\nVerdict: ${entry.verdict}\n---`
      ).join('\n');
      pre.style.display = "block";
    } else {
      pre.style.display = "none";
    }
  }

  window.addEventListener("DOMContentLoaded", () => {
    loadFromStorage();
    setTimeout(updateRiskIndicator, 100);
  });

/* Обновленная магия кликабельных слов */
document.addEventListener('click', async (e) => {
  if (e.target.classList.contains('magic-word')) {
    const word = e.target.innerText.toLowerCase().replace(/[^\w]/g, '');
    
    // Вместо alert создаем стильный тултип
    showMagicTooltip(e, `Definition for "${word}" will appear here.`);
  } else {
    // Убираем окно при клике в любое другое место
    const oldTip = document.querySelector('.magic-tooltip');
    if (oldTip) oldTip.remove();
  }
});

function showMagicTooltip(event, text) {
  const oldTip = document.querySelector('.magic-tooltip');
  if (oldTip) oldTip.remove();

  const tip = document.createElement('div');
  tip.className = 'magic-tooltip';
  tip.innerText = text;

  // Стили, соответствующие вашему темному неоновому интерфейсу
  Object.assign(tip.style, {
    position: 'fixed',
    top: `${event.clientY + 15}px`,
    left: `${event.clientX}px`,
    background: '#0a0a0a',
    color: 'var(--creativity-color)',
    padding: '10px 15px',
    border: '1px solid #333',
    fontSize: '11px',
    zIndex: '10000',
    pointerEvents: 'none',
    boxShadow: '0 4px 15px rgba(0,0,0,0.5)',
    fontFamily: 'var(--main-font)'
  });

  document.body.appendChild(tip);
  
  // Автоматическое исчезновение через 4 секунды
  setTimeout(() => { if(tip) tip.remove(); }, 4000);
}


/* Магия кликабельных слов */
const dictionaryUrl = 'lexicon.json'; // Тот самый внешний адрес

function enchantText(selector) {
  const element = document.querySelector(selector);
  if (!element) return;

  // Рекурсивно проходим по текстовым узлам, чтобы не сломать HTML-теги
  const walker = document.createTreeWalker(element, NodeFilter.SHOW_TEXT, null, false);
  let node;
  const nodesToReplace = [];

  while (node = walker.nextNode()) {
    if (node.parentElement.tagName !== 'SCRIPT' && node.textContent.trim().length > 0) {
      nodesToReplace.push(node);
    }
  }

  nodesToReplace.forEach(textNode => {
    const wrapper = document.createElement('span');
    wrapper.innerHTML = textNode.textContent.replace(/(\w+)/g, '<span class="magic-word" style="cursor: pointer; border-bottom: 1px dotted #444;">$1</span>');
    textNode.parentNode.replaceChild(wrapper, textNode);
  });
}

document.addEventListener('click', async (e) => {
  if (e.target.classList.contains('magic-word')) {
    const word = e.target.innerText.toLowerCase();
    
    // Имитация обращения к JSON/PY
    // const response = await fetch(`${dictionaryUrl}?word=${word}`);
    // const data = await response.json();
    
    alert(`Значение "${word}": Здесь будет ответ из вашего JSON`); 
    // В будущем заменим alert на стильное всплывающее окно
  }
});

// Активация магии
window.addEventListener("DOMContentLoaded", () => {
  enchantText('.protocol-content');
});


</script>
</body>
</html>
