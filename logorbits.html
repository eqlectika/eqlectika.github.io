<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Solar System Orbital Trajectories</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 0;
      background-color: #000; color: #fff;
      font-family: monospace; overflow: hidden;
      height: 100vh; display: flex; flex-direction: column;
      user-select: none; -webkit-tap-highlight-color: transparent;
    }
    h1 { margin: 10px 0; font-size: 1.1rem; text-align: center; flex-shrink: 0; }
    
    #top-controls { padding: 5px; flex-shrink: 0; text-align: center; }
    .control-container { display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 5px; }
    #date-picker, #pause-btn { background: #222; color: #fff; border: 1px solid #444; padding: 5px; font-family: monospace; }
    .speed-slider { width: 70%; max-width: 300px; }

    #canvas-wrapper {
      flex: 1; /* Занимает всё свободное место */
      position: relative;
      display: flex; justify-content: center; align-items: center;
      overflow: hidden;
    }
    #orbitCanvas { background-color: #000; touch-action: none; cursor: move; }

    #bottom-ui { flex-shrink: 0; padding: 10px; background: rgba(0,0,0,0.8); }
    #controls { display: flex; justify-content: center; gap: 20px; margin-bottom: 10px; }
    #legend { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; font-size: 0.75rem; }
    .legend-item { display: flex; align-items: center; gap: 5px; cursor: pointer; transition: opacity 0.2s; }
    .color-box { width: 10px; height: 10px; border-radius: 50%; }
    .hidden-planet { opacity: 0.3; }

    .footer-logo-container { text-align: center; padding: 5px; flex-shrink: 0; }
    .logo-image { max-width: 40px; opacity: 0.6; }
  </style>
</head>
<body>

  <h1>Solar System Trajectories</h1>

  <div id="top-controls">
    <div class="control-container">
      <input type="date" id="date-picker" value="2000-01-01">
      <button id="pause-btn">Pause</button>
    </div>
    <input type="range" id="speed-slider" class="speed-slider" min="0" max="2" step="0.1" value="0.3">
  </div>

  <div id="canvas-wrapper">
    <canvas id="orbitCanvas"></canvas>
  </div>

  <div id="bottom-ui">
    <div id="controls">
      <label><input type="radio" name="frame" value="sun" checked> Sun Focus</label>
      <label><input type="radio" name="frame" value="earth"> Earth Focus</label>
    </div>
    <div id="legend"></div>
  </div>

  <div class="footer-logo-container">
    <img src="logo.png" alt="Logo" class="logo-image">
  </div>

  <script>
    const canvas = document.getElementById('orbitCanvas');
    const ctx = canvas.getContext('2d');
    const legendDiv = document.getElementById('legend');
    const datePicker = document.getElementById('date-picker');
    const pauseBtn = document.getElementById('pause-btn');

    const planets = [
      {name: 'Mercury', distance: 0.387, period: 88, color: '#1e90ff', eccentricity: 0.2056, inclination: 0.1222},
      {name: 'Venus', distance: 0.723, period: 225, color: '#8F00FF', eccentricity: 0.0068, inclination: 0.0593},
      {name: 'Earth', distance: 1.000, period: 365.25, color: '#008000', eccentricity: 0.0167, inclination: 0},
      {name: 'Mars', distance: 1.524, period: 687, color: '#ff4500', eccentricity: 0.0934, inclination: 0.0323},
      {name: 'Jupiter', distance: 5.203, period: 4333, color: '#daa520', eccentricity: 0.0489, inclination: 0.0228},
      {name: 'Saturn', distance: 9.537, period: 10759, color: '#deb887', eccentricity: 0.0565, inclination: 0.0436},
      {name: 'Uranus', distance: 19.191, period: 30687, color: '#40e0d0', eccentricity: 0.0464, inclination: 0.0135},
      {name: 'Neptune', distance: 30.068, period: 60190, color: '#4169e1', eccentricity: 0.0095, inclination: 0.0309}
    ];

    let planetVisibility = planets.map(() => true);
    const J2000 = new Date('2000-01-01T12:00:00Z');
    let t = 0;
    let dt = 0.3;
    let frame = 'sun';
    const earthIndex = planets.findIndex(p => p.name === 'Earth');
    const trajectories = planets.map(() => []);
    
    let scale = 1.0; 
    let offsetX = 0;
    let offsetY = 0;
    let isPaused = false;
    let isDragging = false;
    let lastX, lastY;

    function initCanvas() {
      const wrapper = document.getElementById('canvas-wrapper');
      const size = Math.min(wrapper.clientWidth, wrapper.clientHeight);
      canvas.width = size;
      canvas.height = size;
    }

    function createLegend() {
      legendDiv.innerHTML = '';
      planets.forEach((planet, index) => {
        const item = document.createElement('div');
        item.className = 'legend-item' + (planetVisibility[index] ? '' : ' hidden-planet');
        item.innerHTML = `<div class="color-box" style="background:${planet.color}"></div><span>${planet.name}</span>`;
        item.onclick = () => {
          planetVisibility[index] = !planetVisibility[index];
          createLegend();
          trajectories[index] = [];
          if (isPaused) renderStaticFrame();
        };
        legendDiv.appendChild(item);
      });
    }

    // --- Инструментарий отрисовки ---
    function solveKepler(M, e) {
      let E = M, delta;
      for(let i=0; i<6; i++) {
        delta = (E - e * Math.sin(E) - M) / (1 - e * Math.cos(E));
        E -= delta;
      }
      return E;
    }

    function getTrueAnomaly(E, e) {
      return Math.atan2(Math.sqrt(1 - e * e) * Math.sin(E), Math.cos(E) - e);
    }

    function getPos(planet, time) {
      const maxDistance = planets[planets.length - 1].distance;
      const maxOrbitRadius = (canvas.width / 2) - 30;
      const a = (planet.distance / maxDistance) * maxOrbitRadius;
      const M = (2 * Math.PI * time) / planet.period;
      const E = solveKepler(M, planet.eccentricity);
      const theta = getTrueAnomaly(E, planet.eccentricity);
      const r = a * (1 - planet.eccentricity**2) / (1 + planet.eccentricity * Math.cos(theta));
      return {
        x: r * Math.cos(theta) * scale,
        y: r * Math.sin(theta) * Math.cos(planet.inclination) * scale,
        a: a * scale,
        e: planet.eccentricity,
        incl: planet.inclination
      };
    }

    function renderStaticFrame() {
      if (isPaused) requestAnimationFrame(animate);
    }

    // --- События ---
    canvas.addEventListener('wheel', e => {
      e.preventDefault();
      const zoomSpeed = 0.001;
      scale *= (1 - e.deltaY * zoomSpeed);
      scale = Math.max(0.1, Math.min(scale, 20));
      trajectories.forEach(arr => arr.length = 0);
      if (isPaused) renderStaticFrame();
    }, {passive: false});

    canvas.addEventListener('mousedown', e => { isDragging = true; lastX = e.clientX; lastY = e.clientY; });
    window.addEventListener('mousemove', e => {
      if (!isDragging) return;
      offsetX += (e.clientX - lastX);
      offsetY += (e.clientY - lastY);
      lastX = e.clientX; lastY = e.clientY;
      trajectories.forEach(arr => arr.length = 0);
      if (isPaused) renderStaticFrame();
    });
    window.addEventListener('mouseup', () => isDragging = false);

    datePicker.onchange = (e) => {
      t = (new Date(e.target.value) - J2000) / 86400000;
      isPaused = true; pauseBtn.textContent = 'Resume';
      trajectories.forEach(arr => arr.length = 0);
      renderStaticFrame();
    };

    pauseBtn.onclick = () => {
      isPaused = !isPaused;
      pauseBtn.textContent = isPaused ? 'Resume' : 'Pause';
      if (!isPaused) animate();
    };

    document.getElementsByName('frame').forEach(r => r.onchange = (e) => {
      frame = e.target.value;
      trajectories.forEach(arr => arr.length = 0);
      if (isPaused) renderStaticFrame();
    });

    function animate() {
      const centerX = canvas.width / 2 + offsetX;
      const centerY = canvas.height / 2 + offsetY;
      
      ctx.fillStyle = 'black';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      const planetPositions = planets.map(p => getPos(p, t));
      const earthPos = planetPositions[earthIndex];

      // Отрисовка орбит
      ctx.strokeStyle = '#222';
      ctx.setLineDash([2, 4]);
      planets.forEach((p, i) => {
        if (!planetVisibility[i]) return;
        const pos = planetPositions[i];
        const b = pos.a * Math.sqrt(1 - pos.e**2) * Math.cos(pos.incl);
        ctx.beginPath();
        if (frame === 'sun') {
          ctx.ellipse(centerX + pos.a * pos.e, centerY, pos.a, b, 0, 0, Math.PI * 2);
        } else {
          ctx.ellipse(centerX + (pos.a * pos.e) - (earthPos.x), centerY - earthPos.y, pos.a, b, 0, 0, Math.PI * 2);
        }
        ctx.stroke();
      });
      ctx.setLineDash([]);

      // Отрисовка планет
      planetPositions.forEach((pos, i) => {
        if (!planetVisibility[i]) return;
        let dx = centerX + pos.x;
        let dy = centerY + pos.y;
        
        if (frame === 'earth') {
          dx = centerX + (pos.x - earthPos.x);
          dy = centerY + (pos.y - earthPos.y);
        }

        // Траектории
        trajectories[i].push({x: dx, y: dy});
        if (trajectories[i].length > 200) trajectories[i].shift();
        ctx.beginPath();
        ctx.strokeStyle = planets[i].color;
        trajectories[i].forEach((p, idx) => {
          if (idx === 0) ctx.moveTo(p.x, p.y);
          else ctx.lineTo(p.x, p.y);
        });
        ctx.stroke();

        // Тело планеты
        ctx.beginPath();
        ctx.fillStyle = planets[i].color;
        ctx.arc(dx, dy, 4, 0, Math.PI*2);
        ctx.fill();
      });

      // Солнце
      let sX = centerX, sY = centerY;
      if (frame === 'earth') { sX -= earthPos.x; sY -= earthPos.y; }
      ctx.beginPath(); ctx.fillStyle = 'yellow';
      ctx.arc(sX, sY, 6, 0, Math.PI*2); ctx.fill();

      // Инфо
      ctx.fillStyle = 'white'; ctx.font = '12px monospace';
      ctx.fillText(`Scale: ${scale.toFixed(2)}x | Date: ${new Date(J2000.getTime() + t * 86400000).toISOString().split('T')[0]}`, 10, 20);

      if (!isPaused) {
        t += dt;
        requestAnimationFrame(animate);
      }
    }

    initCanvas();
    createLegend();
    animate();
  </script>
</body>
</html>
