<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
                 <link rel="manifest" href="manifestmatrix.json">
<title>Neural Matrix</title>

        <link href="https://fonts.googleapis.com/css2?family=Ubuntu&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg: #000; --text: #fff; --accent: #00ff00; --tension: #ff1493; --dim: #111; }
        * { box-sizing: border-box; font-family: 'Ubuntu', monospace; -webkit-tap-highlight-color: transparent; }
        body, html { margin: 0; padding: 0; height: 100dvh; background: var(--bg); color: var(--text); overflow: hidden; display: flex; flex-direction: column; }

        .pane-wrap { position: relative; height: 100%; width: 100%; overflow: hidden; }
        .pane { border: none; padding: 10px; font-size: 0.85rem; background: var(--bg); color: var(--text); outline: none; resize: none; width: 100%; height: 100%; }
        .pane-l { color: #fff; border-right: 1px solid var(--dim); }

        #save-btn { 
            position: absolute; bottom: 5px; right: 5px; background: var(--accent); color: #000; 
            padding: 4px 10px; font-size: 0.6rem; font-weight: bold; cursor: pointer; display: none; z-index: 150;
        }

#gateway { 
    display: grid; 
    grid-template-columns: 50% 50%; 
    height: 45vh; /* Занимает почти половину экрана */
    width: 100%; 
    position: relative; 
    border-bottom: 1px solid var(--dim); 
    flex-shrink: 0; 
}

#flash-zone { 
    height: 20vh; /* Ровно 1/5 экрана */
    display: flex; 
    visibility: hidden; 
    flex-direction: column; 
    justify-content: center; 
    align-items: center;
    background: #050505; 
    position: relative; 
    border-bottom: 1px solid var(--dim);
    flex-shrink: 0;
}

#basement { 
    flex-grow: 1; /* Забирает весь остаток (примерно 35% экрана минус кнопки) */
    width: 100%; 
    background: #000; 
    display: flex; 
    flex-direction: column; 
    border-top: 1px solid var(--dim); 
    overflow-y: auto; 
}



#flash-zone.visible { visibility: visible; }




#gate-btn {
    position: absolute; 
    left: 50%; /* Линия четко на границе сечения */
    top: 0; 
    bottom: 0; 
    width: 22px; 
    transform: translateX(-50%); 
    z-index: 200; 
    cursor: pointer;
    background: var(--accent); 
    display: flex; 
    align-items: center; 
    justify-content: center;
}

#digText {
    padding-left: 25px; color: #00ff00; /* Комфортный зазор для Digest */
}



        #gate-btn span { writing-mode: vertical-rl; text-orientation: upright; color: #000; font-weight: 900; font-size: 0.8rem; letter-spacing: 3px; }
        #gate-btn.active { background: var(--tension); }



        #word-stream { font-size: 2.8rem; font-weight: bold; text-align: center; cursor: pointer; width: 95%; color: var(--text); }

        /* PINK CONTROLS */
#control-hub {
    height: 40px; 
    width: 100%; 
    display: none; /* Скрыто */
    justify-content: space-around; 
    align-items: center;
    background: #000; 
    flex-shrink: 0;
}

        .u-btn { color: var(--tension); font-size: 0.7rem; cursor: pointer; font-weight: bold; }

        /* BASEMENT (Фиксированная высота, прокрутка внутри) */
        #basement { height: 140px; width: 100%; background: #000; display: flex; flex-direction: column; flex-shrink: 0; border-top: 1px solid var(--dim); overflow-y: auto; }
#index-row {
    width: 100%; 
    min-height: 25px; 
    display: flex; 
    align-items: center; 
    justify-content: center; /* Центрирует текст по горизонтали */
    color: var(--accent); 
    font-size: 0.8rem; 
    letter-spacing: 12px; 
padding-left: 12px;
    font-weight: bold; 
    background: #000;
}

        #monitor { min-height: 60px; width: 100%; position: relative; }


#db-tools { 
    min-height: 45px; 
    display: flex; 
    justify-content: center; /* Центрирует всё содержимое */
    align-items: center; 
    gap: 20px; 
    padding: 5px; 
}

.db-btn { 
    font-size: 0.7rem; 
    color: var(--accent); /* Изменили с #666 на ярко-зеленый */
    cursor: pointer; 
    border: 1px solid var(--accent); /* Добавили рамку в цвет текста */
    padding: 5px 10px; 
    text-transform: uppercase; 
    font-weight: bold;
    transition: 0.3s; /* Для плавного эффекта */
}

/* Центрирование самого логотипа как отдельного блока */
.centered-logo {
    display: flex;
    justify-content: center;
    align-items: center;
    width: 100%;
    padding: 10px 0;
    text-decoration: none;
}



        video { position: fixed; width: 1px; height: 1px; opacity: 0; }
 




/* Стили из loop.html, адаптированные под Matrix */
footer { padding: 10px 0; flex-shrink: 0; }

.donate-btn { 
    color: #888; 
border: 1px solid #444; 
padding: 5px 15px; 
    background: transparent; 
cursor: pointer; 
font-size: 0.6rem; 
text-transform: uppercase; 
width: fit-content;
    margin: 0 auto; 
}


.donate-box { 
    display: flex; 
    flex-direction: column; 
    align-items: center; /* Центрирует кнопку и крипто-адрес */
    gap: 8px; 
    padding: 0 15px; 
    text-align: center; /* Центрирует текст внутри блоков */
}


.crypto-info { display: none; flex-direction: column; gap: 5px; margin-top: 10px; }
.crypto-address-display { 
    font-size: 10px; color: var(--accent); background: #0a0a0a; 
    padding: 8px; border: 1px dashed #333; cursor: copy; word-break: break-all; 
}

   </style>
</head>
<body>

    <video id="video" autoplay playsinline muted></video>

    <div id="gateway">
        <div class="pane-wrap"><textarea id="srcText" class="pane pane-l" placeholder="SOURCE"></textarea></div>
        <div class="pane-wrap">
            <textarea id="digText" class="pane" placeholder="DIGEST" oninput="checkDigest()"></textarea>
            <div id="save-btn" onclick="exportDB()">SAVE</div>
        </div>
        <div id="gate-btn" onclick="toggleSystem()"><span>GATE</span></div>
    </div>

    <div id="flash-zone">
        <div id="word-stream" onclick="captureWord()">READY</div>
    </div>

    <div id="control-hub">
        <div class="u-btn" onclick="move(-1)">PREV</div>
        <div class="u-btn" onclick="adjSpd(-50)">SLOWER</div>
        <div class="u-btn" id="run-btn" onclick="toggleRun()">RUN</div>
        <div class="u-btn" onclick="adjSpd(50)">FASTER</div>
        <div class="u-btn" onclick="move(1)">NEXT</div>
    </div>

<div id="basement">
    <div id="index-row">RQ:85</div>
    <div id="monitor"><canvas id="sparkChart"></canvas></div>
    
<div id="db-tools" style="flex-direction: column; gap: 10px;">
    <div style="display: flex; gap: 20px;">
        <div class="db-btn" onclick="downloadDB()">EXPORT DB</div>
        <div class="db-btn" onclick="document.getElementById('importInput').click()">IMPORT DB</div>
    </div>

    <input type="file" id="importInput" style="display:none" onchange="importDB(event)">
</div>

<div style="margin-top: 20px; display: flex; flex-direction: column; align-items: center; gap: 20px; margin-bottom: 20px;">
    
    <div class="db-btn" onclick="toggleInfo()" style="border: none; width: fit-content;">INFO</div>

    <div id="info-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.98); z-index:2000; padding:25px; overflow-y:auto; font-size:0.75rem; color:var(--text); line-height:1.6;">
        <h2 style="color:var(--accent); border-bottom:1px solid var(--accent); letter-spacing: 2px;">NEURAL MATRIX PROTOCOL</h2>
        <p><strong style="color:var(--tension);">BIO-SYNC:</strong> The camera stream serves as a biometric anchor, preventing device sleep mode and ensuring operator cognitive synchronization with the data flow.</p>
        <p><strong style="color:var(--accent);">GATE:</strong> Activates the processing buffer. Loads data from SOURCE into the active stream.</p>
        <p><strong style="color:var(--accent);">FLASH CAPTURE:</strong> Clicking a word in the Flash Zone archives it to DIGEST. The system employs a deduplication filter to prevent redundant entries.</p>
        <p><strong style="color:var(--accent);">RECURSIVE CACHE:</strong> The SAVE command links current data to localStorage. Recognized words will automatically pull their definitions from the cache upon capture.</p>
        <p><strong style="color:var(--accent);">RQ MONITOR:</strong> Tracks system stability. Adjust SPEED (Faster/Slower) to maintain optimal processing frequency.</p>
        <p><strong style="color:var(--accent);">IO OPS:</strong> Use EXPORT to generate a physical backup (.json) and IMPORT to restore a database from local storage.</p>
        <button onclick="toggleInfo()" style="background:var(--accent); border:none; padding:12px; width:100%; margin-top:30px; font-weight:900; color:#000; cursor:pointer; font-family:inherit; text-transform:uppercase;">Return to Matrix</button>
    </div>

    <a href="index.html" style="display: flex; justify-content: center; text-decoration: none; opacity: 0.9;">
        <img src="logo.png" alt="Feedback" style="height: 38px; width: auto;">
    </a>
</div>



    <footer>
        <div class="donate-box">
            <button class="donate-btn" onclick="toggleDonate()">Support</button>
            <div id="cryptoInfo" class="crypto-info">
                <span style="font-size: 10px; color: #fff;">USDT BSC (BEP20)</span>
                <div id="cryptoAddr" class="crypto-address-display" onclick="copyToClipboard()">0x769192cea8fbb7207f086d95fd653ebc3adb0c72</div>
                <span id="copyHint" style="font-size: 9px; color: #aaa;">Click address to copy</span>
            </div>
        </div>
    </footer>
</div>



    <script>
        let isRunning = false, isPaused = true, words = [], currentIdx = 0, speed = 300, rq = 85, timer = null;

        const chart = new Chart(document.getElementById('sparkChart').getContext('2d'), {
            type: 'line',
            data: { labels: Array(40).fill(''), datasets: [{ borderColor: '#00ff00', borderWidth: 1, data: Array(40).fill(85), pointRadius: 0, fill: false, tension: 0.4 }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { display: false, max: 100, min: 0 }, x: { display: false } }, plugins: { legend: { display: false } } }
        });

function toggleSystem() {
    const flash = document.getElementById('flash-zone');
    const btn = document.getElementById('gate-btn');
    const hub = document.getElementById('control-hub');

    if (!isRunning) {
        words = document.getElementById('srcText').value.split(/\s+/).filter(w => w.length > 0);
        if (words.length === 0) return alert("Введите текст в SOURCE");

        navigator.mediaDevices.getUserMedia({video: true}).then(s => { document.getElementById('video').srcObject = s; }).catch(() => {});

        flash.classList.add('visible'); 
        hub.style.display = 'flex'; 
        btn.classList.add('active');
        isRunning = true; currentIdx = 0; isPaused = true; update();
    } else {
        isRunning = false; isPaused = true; clearTimeout(timer);
        flash.classList.remove('visible'); 
        hub.style.display = 'none'; 
        btn.classList.remove('active');
    }
}




        function update() {
            if (!words[currentIdx]) return;
            document.getElementById('word-stream').innerText = words[currentIdx];
            document.getElementById('index-row').innerText = `RQ: ${Math.round(rq)}`;
        }

        function toggleRun() {
            if (!isRunning) return;
            isPaused = !isPaused;
            document.getElementById('run-btn').innerText = isPaused ? 'RUN' : 'STOP';
            document.getElementById('run-btn').style.color = isPaused ? '' : 'var(--tension)';
            if (!isPaused) loop();
        }

        function loop() {
            if (isRunning && !isPaused && currentIdx < words.length - 1) {
                currentIdx++; update();
                timer = setTimeout(loop, 60000 / (speed * (rq/100)));
            }
        }

        function adjSpd(d) { speed = Math.max(50, speed + d); update(); }
        function move(d) { currentIdx = Math.max(0, Math.min(words.length-1, currentIdx + d)); update(); }

function captureWord() {
    if (!words[currentIdx]) return;
    
    // Очищаем слово от пунктуации для поиска
    const w = words[currentIdx].replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g,"").trim();
    const dig = document.getElementById('digText');
    const currentContent = dig.value;

    // 1. Проверка на дубликат: если слово (с двоеточием) уже есть в Digest, выходим
    const wordPattern = new RegExp('(^|\\n)' + w + ':', 'm');
    if (wordPattern.test(currentContent)) {
        // Краткая индикация, что слово уже есть (вспышка цветом)
        document.getElementById('word-stream').style.color = '#555';
        setTimeout(() => document.getElementById('word-stream').style.color = '', 100);
        return;
    }

    // 2. Поиск определения в базе (localStorage)
    let definition = "";
    const cached = localStorage.getItem('matrix_cache');
    if (cached) {
        const data = JSON.parse(cached);
        if (data.dig) {
            // Ищем строку, начинающуюся со слова и двоеточия
            const lines = data.dig.split('\n');
            const foundLine = lines.find(line => line.startsWith(w + ':'));
            if (foundLine) {
                definition = foundLine.substring(w.length + 1).trim();
            }
        }
    }

    // 3. Формирование строки
    const prefix = dig.value.trim().length > 0 ? '\n' : '';
    dig.value += prefix + w + ': ' + definition;
    dig.scrollTop = dig.scrollHeight; 

    checkDigest();
    
    document.getElementById('word-stream').style.color = 'var(--tension)';
    setTimeout(() => document.getElementById('word-stream').style.color = '', 100);
}





        function checkDigest() {
            document.getElementById('save-btn').style.display = document.getElementById('digText').value.trim().length > 0 ? 'block' : 'none';
        }

function exportDB() {
    const data = {
        src: document.getElementById('srcText').value,
        dig: document.getElementById('digText').value
    };
    localStorage.setItem('matrix_cache', JSON.stringify(data));
    
    // Визуальный отклик
    const btn = document.getElementById('save-btn');
    const originalText = btn.innerText;
    btn.innerText = 'CACHED';
    btn.style.background = 'var(--tension)';
    setTimeout(() => { 
        btn.innerText = originalText; 
        btn.style.background = 'var(--accent)';
    }, 1000);
}


        function downloadDB() {
    const data = JSON.stringify({
        src: document.getElementById('srcText').value,
        dig: document.getElementById('digText').value
    });
    const blob = new Blob([data], {type: 'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'matrix_backup.json';
    a.click();
}
function toggleInfo() {
    const modal = document.getElementById('info-modal');
    modal.style.display = modal.style.display === 'none' ? 'block' : 'none';
}


        setInterval(() => {
    // Вычисляем новое значение
    rq = Math.max(10, Math.min(100, rq + (Math.random() - 0.5) * 6));
    
    // Обновляем график
    chart.data.datasets[0].data.push(rq); 
    chart.data.datasets[0].data.shift();
    chart.update('none');
    
    // ДОБАВЬТЕ ЭТУ СТРОКУ: она обновляет цифру в блоке index-row
    document.getElementById('index-row').innerText = `RQ: ${Math.round(rq)}`;
    
    // Меняем цвет в зависимости от состояния
    const c = rq > 50 ? '#00ff00' : '#ff1493';
    document.getElementById('index-row').style.color = c;
    chart.data.datasets[0].borderColor = c;
}, 1000);

        
function toggleDonate() { 
    const info = document.getElementById("cryptoInfo"); 
    const basement = document.getElementById("basement");
    const isOpening = info.style.display !== "flex";
    
    info.style.display = isOpening ? "flex" : "none"; 
    
    if (isOpening) {
        setTimeout(() => {
            // Центрируем блок доната в видимой области подвала
            info.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 100);
    }
}





function copyToClipboard() {
    const addr = document.getElementById("cryptoAddr");
    const text = addr.innerText;
    navigator.clipboard.writeText(text).then(() => {
        const originalText = text;
        addr.innerText = "COPIED!";
        addr.style.color = "var(--tension)";
        setTimeout(() => {
            addr.innerText = originalText;
            addr.style.color = "var(--accent)";
        }, 1500);
    });
}
// Добавьте это в конец скрипта, чтобы данные подтягивались при открытии
window.addEventListener('DOMContentLoaded', () => {
    const cached = localStorage.getItem('matrix_cache');
    if (cached) {
        const data = JSON.parse(cached);
        document.getElementById('srcText').value = data.src || '';
        document.getElementById('digText').value = data.dig || '';
        checkDigest();
    }
});
    </script>
</body>
</html>
